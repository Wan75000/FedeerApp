<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fish Feeder Control Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
    <style>
        /* Styling dashboard */
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: linear-gradient(to bottom, white, #1E3D58); }
        h1, h2 { text-align: center; color: navy; }
        #status { text-align: center; font-size: 20px; }
        button { background-color: navy; color: white; padding: 10px 20px; margin: 10px; cursor: pointer; border: none; font-size: 16px; }
        input[type="time"] { padding: 10px; font-size: 16px; }
        .container { padding: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<!-- Screen 1: Login -->
<div id="screen1" class="container">
    <h1>Login WiFi</h1>
    <form id="wifiForm" onsubmit="connectWiFi(event)">
        <label>Username WiFi: <input type="text" id="wifiUser" required></label><br><br>
        <label>Password WiFi: <input type="password" id="wifiPass" required></label><br><br>
        <button type="submit">Connect WiFi</button>
    </form>
    <div id="status">Connecting to WiFi...</div>
</div>

<!-- Screen 2: Control Dashboard -->
<div id="screen2" class="container hidden">
    <h1>Fish Feeder Control Dashboard</h1>
    <div id="status">Connecting to MQTT...</div>

    <!-- Manual Control -->
    <button id="feedNowBtn">Feed Now</button>
    <button id="stopBtn">Stop Feeding</button>

    <!-- Schedule Setting -->
    <h2>Set Feeding Schedule</h2>
    <form onsubmit="updateSchedule(event)">
        <label>Time 1: <input type="time" id="time1" value="08:00"></label><br><br>
        <label>Time 2: <input type="time" id="time2" value="12:00"></label><br><br>
        <label>Time 3: <input type="time" id="time3" value="17:00"></label><br><br>
        <button type="submit">Update Schedule</button>
    </form>

    <button id="exitBtn">Exit</button>
</div>

<script>
    // Mengatur URL broker dan kredensial menggunakan MQTT HiveMQ Cloud (WSS)
    const brokerUrl = 'wss://8cb15def763044589905db3abee4c47d.s1.eu.hivemq.cloud:8884/mqtt'; // URL WebSocket TLS
    const clientId = 'hivemq.webclient.1737922294562'; // ID klien yang unik
    const username = 'Wan75000';  // Username MQTT HiveMQ Cloud
    const password = 'Ksd75400';  // Password MQTT HiveMQ Cloud

    let client;

    // Fungsi untuk koneksi WiFi dan kemudian MQTT
    function connectWiFi(event) {
        event.preventDefault();
        const wifiUser = document.getElementById("wifiUser").value;
        const wifiPass = document.getElementById("wifiPass").value;

        // Verifikasi kredensial Wi-Fi (hanya contoh, perlu koneksi Wi-Fi yang nyata untuk perangkat IoT)
        if (wifiUser && wifiPass) {
            document.getElementById("status").innerText = "Connected to WiFi!";
            // Beralih ke layar 2 setelah berhasil
            document.getElementById("screen1").classList.add("hidden");
            document.getElementById("screen2").classList.remove("hidden");
            connectMQTT();  // Sambungkan ke MQTT setelah Wi-Fi terhubung
        } else {
            alert("WiFi Username or Password is incorrect");
        }
    }

    // Fungsi untuk menghubungkan ke MQTT
    function connectMQTT() {
        client = mqtt.connect(brokerUrl, {
            clientId: clientId,
            username: username,
            password: password,
            clean: true,  // Session bersih setelah disconnect
            reconnectPeriod: 1000,  // Waktu untuk mencoba reconnect
        });

        client.on('connect', function () {
            document.getElementById('status').innerText = 'Connected to MQTT Broker';
            console.log('Connected to MQTT Broker');
            // Subscribe ke topik kontrol servo dan jadwal
            client.subscribe('servo/control', { qos: 1 });
            client.subscribe('servo/schedule', { qos: 1 });
            client.subscribe('device/status', { qos: 1 });
            console.log('Subscribed to topics: servo/control, servo/schedule, device/status');
        });

        client.on('message', function (topic, message) {
            console.log('Message received:', topic, message.toString());
        });
    }

    // Fungsi untuk mengirim perintah kontrol langsung ke servo
    document.getElementById('feedNowBtn').addEventListener('click', function() {
        const message = 'ON';  // Perintah untuk menyalakan servo (pemberian pakan)
        client.publish('servo/control', message, { qos: 1 });
        console.log('Feed Now command sent');
    });

    // Fungsi untuk menghentikan pemberian pakan
    document.getElementById('stopBtn').addEventListener('click', function() {
        const message = 'OFF';  // Perintah untuk mematikan servo
        client.publish('servo/control', message, { qos: 1 });
        console.log('Stop command sent');
    });

    // Fungsi untuk memperbarui jadwal pemberian pakan
    function updateSchedule(event) {
        event.preventDefault();
        const schedule = {
            schedule: [
                document.getElementById("time1").value,
                document.getElementById("time2").value,
                document.getElementById("time3").value
            ]
        };
        client.publish('servo/schedule', JSON.stringify(schedule), { qos: 1 });
        console.log('Schedule updated:', schedule);
    }

    // Fungsi untuk keluar dari dashboard
    document.getElementById('exitBtn').addEventListener('click', function() {
        window.location.reload(); // Memuat ulang halaman untuk keluar
    });
</script>

</body>
</html>
